<!DOCTYPE html>
<html>
<head>
    <title>Sega Genesis Palette Editor</title>
    <style>
        .color-box {
            width: 32px;
            height: 32px;
            display: inline-block;
        }
        .control-bar {
            display: none;
            margin-top: 8px;
        }
        .slider {
            width: 100px;
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput" accept=".pal">
    <div id="paletteContainer"></div>
    <div id="controlBar" class="control-bar">
        Red: <input id="redSlider" class="slider" type="range" min="0" max="14" step="2"><br>
        Green: <input id="greenSlider" class="slider" type="range" min="0" max="14" step="2"><br>
        Blue: <input id="blueSlider" class="slider" type="range" min="0" max="14" step="2">
        <div id="colorValue">Color Value: 0000</div>
    </div>
    <button id="exportButton">Export as PNG</button>
    <button id="savePaletteButton">Save Palette</button>

    <script>
        let currentColorBox = null;
        let paletteData = new Uint8Array(128);

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    paletteData = new Uint8Array(e.target.result);
                    const paletteContainer = document.getElementById('paletteContainer');
                    paletteContainer.innerHTML = '';

                    for (let i = 0; i < 64; i++) {
                        const wordValue = (paletteData[i * 2] << 8) | paletteData[i * 2 + 1];
                        const blue = (wordValue >> 8) & 0x0E;
                        const green = (wordValue >> 4) & 0x0E;
                        const red = wordValue & 0x0E;

                        const colorBox = document.createElement('div');
                        colorBox.className = 'color-box';
                        colorBox.style.backgroundColor = `rgb(${red * 16}, ${green * 16}, ${blue * 16})`;

                        colorBox.addEventListener('click', function() {
                            showControlBar(this);
                        });

                        paletteContainer.appendChild(colorBox);

                        if ((i + 1) % 16 === 0) {
                            // Start a new row after displaying 16 colors
                            paletteContainer.appendChild(document.createElement('br'));
                        }
                    }
                };

                reader.readAsArrayBuffer(file);
            }
        });

        document.getElementById('redSlider').addEventListener('input', function() {
            if (currentColorBox) {
                updateColor(currentColorBox);
            }
        });

        document.getElementById('greenSlider').addEventListener('input', function() {
            if (currentColorBox) {
                updateColor(currentColorBox);
            }
        });

        document.getElementById('blueSlider').addEventListener('input', function() {
            if (currentColorBox) {
                updateColor(currentColorBox);
            }
        });

        function showControlBar(colorBox) {
            const controlBar = document.getElementById('controlBar');
            currentColorBox = colorBox;
            const colorStyle = getComputedStyle(colorBox);
            const color = colorStyle.backgroundColor.match(/\d+/g);
            const red = parseInt(color[0]) / 16;
            const green = parseInt(color[1]) / 16;
            const blue = parseInt(color[2]) / 16;

            document.getElementById('redSlider').value = red;
            document.getElementById('greenSlider').value = green;
            document.getElementById('blueSlider').value = blue;
            controlBar.style.display = 'block';
            updateColorValue(red, green, blue);
        }

        function updateColor(colorBox) {
            const red = document.getElementById('redSlider').value;
            const green = document.getElementById('greenSlider').value;
            const blue = document.getElementById('blueSlider').value;
            colorBox.style.backgroundColor = `rgb(${red * 16}, ${green * 16}, ${blue * 16})`;
            updatePalette();
            updateColorValue(red, green, blue);
        }

        function updateColorValue(red, green, blue) {
            const colorValueElement = document.getElementById('colorValue');
            const redHex = red.toString(16).toUpperCase();
            const greenHex = green.toString(16).toUpperCase();
            const blueHex = blue.toString(16).toUpperCase();
            const colorValue = redHex.padStart(2, '0') + greenHex.padStart(2, '0') + blueHex.padStart(2, '0') + '0';
            colorValueElement.textContent = `Color Value: ${colorValue}`;
        }

        function updatePalette() {
            const colorBoxes = document.querySelectorAll('.color-box');

            colorBoxes.forEach((colorBox, index) => {
                const colorStyle = getComputedStyle(colorBox);
                const color = colorStyle.backgroundColor.match(/\d+/g);
                const red = parseInt(color[0]) / 16;
                const green = parseInt(color[1]) / 16;
                const blue = parseInt(color[2]) / 16;

                const wordValue = (blue << 8) | (green << 4) | red;
                paletteData[index * 2] = (wordValue >> 8) & 0xFF;
                paletteData[index * 2 + 1] = wordValue & 0xFF;
            });

            // Update the palette in the exported image (if any)
            const canvas = document.querySelector('canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                let x = 0;
                let y = 0;

                colorBoxes.forEach((colorBox, index) => {
                    if (index > 0 && index % 16 === 0) {
                        x = 0;
                        y += 16;
                    }

                    const colorStyle = getComputedStyle(colorBox);
                    const color = colorStyle.backgroundColor.match(/\d+/g);
                    const red = parseInt(color[0]);
                    const green = parseInt(color[1]);
                    const blue = parseInt(color[2]);

                    ctx.fillStyle = `rgb(${red}, ${green}, ${blue}`;
                    ctx.fillRect(x, y, 16, 16);
                    x += 16;
                });
            }
        }

        document.getElementById('exportButton').addEventListener('click', function() {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 64; // To accommodate 4 rows without extra space

            const ctx = canvas.getContext('2d');
            const colorBoxes = document.querySelectorAll('.color-box');
            let x = 0;
            let y = 0;

            colorBoxes.forEach((colorBox, index) => {
                if (index > 0 && index % 16 === 0) {
                    x = 0;
                    y += 16; // Reduce the space between rows to zero
                }

                const colorStyle = getComputedStyle(colorBox);
                const color = colorStyle.backgroundColor.match(/\d+/g);
                const red = parseInt(color[0]);
                const green = parseInt(color[1]);
                const blue = parseInt(color[2]);

                ctx.fillStyle = `rgb(${red}, ${green}, ${blue}`;
                ctx.fillRect(x, y, 16, 16); // Make each color square
                x += 16;
            });

            const imgData = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = imgData;
            a.download = 'palette.png';
            a.click();
        });

        document.getElementById('savePaletteButton').addEventListener('click', function() {
            const blob = new Blob([paletteData], { type: 'application/octet-stream' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'edited_palette.pal';
            a.click();
        });
    </script>
</body>
</html>
